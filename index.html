<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SakuraQA ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ« - ãƒ›ãƒ¼ãƒ </title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1>ğŸ“‹ SakuraQA ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ„ãƒ¼ãƒ«</h1>
                <button class="btn btn-primary" onclick="window.location.href='analytics.html'" style="margin: 0;">
                    ğŸ“Š åˆ†æã‚’è¦‹ã‚‹
                </button>
            </div>
        </header>

        <main class="home-content">
            <section class="input-section">
                <h2>ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼æƒ…å ±</h2>
                <div class="form-group">
                    <label for="reviewer-name">ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼å <span class="required">*</span></label>
                    <input
                        type="text"
                        id="reviewer-name"
                        placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                        class="form-input"
                        required
                    >
                    <div class="error-message" id="name-error"></div>
                </div>
            </section>

            <section class="quiz-set-section">
                <h2>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</h2>
                <p class="section-description">ãƒ¬ãƒ“ãƒ¥ãƒ¼ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªã‚’é¸ã‚“ã§ãã ã•ã„</p>

                <div id="loading-categories" class="loading-small">
                    <div class="spinner-small"></div>
                    <p>ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</p>
                </div>

                <div class="quiz-sets" id="quiz-sets" style="display: none;">
                    <!-- ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ãŒJavaScriptã§å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
                </div>

                <div class="error-message" id="category-error"></div>
            </section>

            <div class="error-message global-error" id="global-error"></div>
        </main>

        <!-- é€²æ—å†é–‹ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div id="progress-resume-modal" class="modal" style="display: none;">
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-icon">ğŸ“š</div>
                <h2>å‰å›ã®ç¶šãã‹ã‚‰å§‹ã‚ã¾ã™ã‹ï¼Ÿ</h2>
                <p id="progress-resume-message" class="modal-message"></p>
                <div class="modal-buttons">
                    <button class="btn btn-primary" id="resume-continue-btn">ç¶šãã‹ã‚‰é–‹å§‹</button>
                    <button class="btn btn-secondary" id="resume-restart-btn">æœ€åˆã‹ã‚‰é–‹å§‹</button>
                    <button class="btn btn-text" id="resume-cancel-btn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script>
        const QUESTIONS_PATH = 'quiz/questions.json';

        // ã‚«ãƒ†ã‚´ãƒªã‚¢ã‚¤ã‚³ãƒ³ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        const CATEGORY_ICONS = {
            'é£Ÿ': 'ğŸ•',
            'æ—¥æœ¬ã®é£Ÿæ–‡åŒ–(ç¾ä»£)': 'ğŸ±',
            'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ': 'ğŸ“'
        };

        // ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼åã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        function validateReviewerName() {
            const reviewerName = document.getElementById('reviewer-name').value.trim();
            const errorEl = document.getElementById('name-error');

            if (!reviewerName) {
                errorEl.textContent = 'ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„';
                return false;
            }

            errorEl.textContent = '';
            return true;
        }

        // ã‚«ãƒ†ã‚´ãƒªåˆ¥å•é¡Œã‚»ãƒƒãƒˆã®é–‹å§‹
        async function startQuiz(category, questionCount) {
            if (!validateReviewerName()) {
                document.getElementById('reviewer-name').focus();
                return;
            }

            const reviewerName = document.getElementById('reviewer-name').value.trim();

            // é€²æ—ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆéåŒæœŸï¼‰
            const progress = await StorageManager.getProgress(reviewerName, category);

            // é€²æ—ãŒæœ€å¾Œã¾ã§åˆ°é”ã—ã¦ã„ã‚‹å ´åˆã®ã¿ã€æœªä¿å­˜å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
            const hasCompletedAll = progress && progress.questionIndex >= questionCount - 1;

            if (hasCompletedAll) {
                // å…¨å•è§£ãçµ‚ã‚ã£ãŸäººã®ã¿ï¼šæœªä¿å­˜å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
                try {
                    // å•é¡Œãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
                    const response = await fetch(QUESTIONS_PATH);
                    if (!response.ok) {
                        throw new Error('å•é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    const allQuestions = await response.json();
                    const categoryQuestions = allQuestions.filter(q => q.category === category);

                    // æœªä¿å­˜å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯
                    const missingIndexes = await StorageManager.getMissingQuestions(
                        reviewerName,
                        category,
                        categoryQuestions
                    );

                    if (missingIndexes.length > 0) {
                        // æœªä¿å­˜å•é¡ŒãŒã‚ã‚‹å ´åˆã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                        const choice = await showMissingQuestionsDialog(missingIndexes.length, questionCount);

                        if (choice === 'missing') {
                            // æœªä¿å­˜å•é¡Œãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹
                            startReview(reviewerName, category, false, true);
                            return;
                        } else if (choice === 'cancel') {
                            // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                            return;
                        }
                        // 'normal' ã®å ´åˆã¯é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ
                    } else {
                        // æœªä¿å­˜å•é¡ŒãŒãªã„å ´åˆ
                        alert(`âœ… å…¨ã¦ã®å•é¡Œã‚’è§£ãçµ‚ã‚ã£ã¦ã„ã¾ã™\n\n${questionCount}å•å…¨ã¦ãŒã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã™ã€‚\n\nãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚`);
                        return;
                    }
                } catch (error) {
                    console.error('æœªä¿å­˜å•é¡Œãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', error);
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ
                }
            }

            // é€”ä¸­ã¾ã§è§£ã„ã¦ã„ã‚‹äººã€ã¾ãŸã¯ã¯ã˜ã‚ã¦ã®äººï¼šé€šå¸¸ã®é€²æ—ãƒã‚§ãƒƒã‚¯
            if (progress && progress.questionIndex >= 0 && progress.questionIndex < questionCount - 1) {
                // é€²æ—ãŒã‚ã‚‹å ´åˆã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
                const choice = await showProgressDialog(reviewerName, category, questionCount, progress.questionIndex);

                if (choice === 'continue') {
                    startReview(reviewerName, category, true, false);
                } else if (choice === 'restart') {
                    startReview(reviewerName, category, false, false);
                }
                // cancel ã®å ´åˆã¯ä½•ã‚‚ã—ãªã„
            } else if (!progress) {
                // é€²æ—ãŒãªã„å ´åˆï¼ˆã¯ã˜ã‚ã¦ã®äººï¼‰ã¯ç›´æ¥é–‹å§‹
                startReview(reviewerName, category, false, false);
            }
        }

        // æœªä¿å­˜å•é¡Œãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        function showMissingQuestionsDialog(missingCount, totalCount) {
            return new Promise((resolve) => {
                const message =
                    `âš ï¸ ${totalCount}å•å…¨ã¦ã‚’è§£ãçµ‚ã‚ã£ã¦ã„ã¾ã™ãŒã€\n` +
                    `é€”ä¸­ã®${missingCount}å•ãŒã‚µãƒ¼ãƒãƒ¼ã«ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n\n` +
                    `ã©ã†ã—ã¾ã™ã‹ï¼Ÿ`;
                const userChoice = confirm(message + '\n\nOK: æœªä¿å­˜ã®å•é¡Œã ã‘ã‚’è§£ãç›´ã™\nã‚­ãƒ£ãƒ³ã‚»ãƒ«: é€šå¸¸é€šã‚Šå…¨ã¦ã®å•é¡Œã‚’è§£ã');

                if (userChoice) {
                    resolve('missing');
                } else {
                    // 2ã¤ç›®ã®ç¢ºèª: æœ¬å½“ã«é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œã™ã‚‹ã‹
                    const confirmNormal = confirm('é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ\n\nOK: é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ\nã‚­ãƒ£ãƒ³ã‚»ãƒ«: ä½•ã‚‚ã—ãªã„');
                    if (confirmNormal) {
                        resolve('normal');
                    } else {
                        resolve('cancel');
                    }
                }
            });
        }

        // é€²æ—ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
        function showProgressDialog(reviewerName, category, questionCount, lastIndex) {
            return new Promise((resolve) => {
                const modal = document.getElementById('progress-resume-modal');
                const message = document.getElementById('progress-resume-message');
                const continueBtn = document.getElementById('resume-continue-btn');
                const restartBtn = document.getElementById('resume-restart-btn');
                const cancelBtn = document.getElementById('resume-cancel-btn');

                // å…¨å•è§£ãçµ‚ã‚ã£ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                if (lastIndex >= questionCount - 1) {
                    message.textContent = `å…¨ã¦ã®å•é¡Œã‚’è§£ãçµ‚ã‚ã£ã¦ã„ã¾ã™ã€‚`;
                } else {
                    const nextQuestion = lastIndex + 1;
                    message.textContent = `å•é¡Œ${nextQuestion}/${questionCount}ã‹ã‚‰å†é–‹ã§ãã¾ã™ã€‚`;
                }

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                modal.style.display = 'flex';

                // ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼
                const handleContinue = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve('continue');
                };

                const handleRestart = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve('restart');
                };

                const handleCancel = () => {
                    modal.style.display = 'none';
                    cleanup();
                    resolve('cancel');
                };

                const cleanup = () => {
                    continueBtn.removeEventListener('click', handleContinue);
                    restartBtn.removeEventListener('click', handleRestart);
                    cancelBtn.removeEventListener('click', handleCancel);
                };

                continueBtn.addEventListener('click', handleContinue);
                restartBtn.addEventListener('click', handleRestart);
                cancelBtn.addEventListener('click', handleCancel);
            });
        }

        // ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’é–‹å§‹
        function startReview(reviewerName, category, resume, missingMode) {
            // localStorageã«ä¿å­˜
            localStorage.setItem('current_reviewer', reviewerName);
            localStorage.setItem('current_category', category);
            localStorage.setItem('current_quiz_path', QUESTIONS_PATH);

            // index.htmlã§é€²æ—ç¢ºèªæ¸ˆã¿ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®šï¼ˆsessionStorageï¼‰
            if (resume) {
                sessionStorage.setItem('resume_confirmed', 'true');
            } else {
                sessionStorage.removeItem('resume_confirmed');
            }

            // æœªä¿å­˜å•é¡Œãƒ¢ãƒ¼ãƒ‰ã®ãƒ•ãƒ©ã‚°ã‚’è¨­å®š
            if (missingMode) {
                sessionStorage.setItem('missing_questions_mode', 'true');
            } else {
                sessionStorage.removeItem('missing_questions_mode');
            }

            // ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»é¢ã«é·ç§»
            window.location.href = 'review.html';
        }

        // ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º
        async function loadCategories() {
            try {
                const response = await fetch(QUESTIONS_PATH);
                if (!response.ok) {
                    throw new Error('å•é¡Œãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }

                const questions = await response.json();

                // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«å•é¡Œæ•°ã‚’é›†è¨ˆ
                const categoryMap = {};
                questions.forEach(q => {
                    const category = q.category || 'ãã®ä»–';
                    if (!categoryMap[category]) {
                        categoryMap[category] = 0;
                    }
                    categoryMap[category]++;
                });

                // ã‚«ãƒ†ã‚´ãƒªã‚«ãƒ¼ãƒ‰ã‚’ç”Ÿæˆ
                const container = document.getElementById('quiz-sets');
                container.innerHTML = '';

                Object.entries(categoryMap).forEach(([category, count]) => {
                    const card = document.createElement('div');
                    card.className = 'quiz-card';
                    card.dataset.category = category;
                    card.dataset.count = count;

                    const icon = CATEGORY_ICONS[category] || CATEGORY_ICONS['ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ'];

                    card.innerHTML = `
                        <div class="quiz-card-icon">${icon}</div>
                        <h3>${category}</h3>
                        <p class="quiz-description">${category}ã®å•é¡Œ</p>
                        <div class="quiz-badge">${count}å•</div>
                    `;

                    card.addEventListener('click', async () => {
                        await startQuiz(category, count);
                    });

                    container.appendChild(card);
                });

                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤ºã€ã‚«ãƒ†ã‚´ãƒªã‚’è¡¨ç¤º
                document.getElementById('loading-categories').style.display = 'none';
                container.style.display = 'grid';

            } catch (error) {
                console.error('ã‚«ãƒ†ã‚´ãƒªèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('loading-categories').style.display = 'none';
                document.getElementById('category-error').textContent =
                    'ã‚«ãƒ†ã‚´ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message;
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            // ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼åã®å…¥åŠ›ã§ã‚¨ãƒ©ãƒ¼ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('reviewer-name').addEventListener('input', () => {
                document.getElementById('name-error').textContent = '';
            });

            // ã‚«ãƒ†ã‚´ãƒªã‚’èª­ã¿è¾¼ã‚€
            loadCategories();
        });
    </script>
</body>
</html>
